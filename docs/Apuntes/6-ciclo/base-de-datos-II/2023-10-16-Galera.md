# Galera

Galera es un cluster multi master, lo que implica que todos los nodos son maestros, no existen esclavos.

- Multi maestro
- Tiene replicación síncrona
- Se puede leer y escribir en cualquier nodo
- Tiene un control automático de los nodos, incluso con las caídas.
- Tiene replicación en paralelo, a nivel de fila
- No se usan VIPS (ips virtuales)}

Cada proceso o transacción que se realice en un nodo, al realizar un commit, todo se duplica en el resto de nodos. La diferencia entre una réplica asíncrona o semi síncrona y un cluster es:

1. La replicación tiene un gap en el que no se han realizado cambios, y en los esclavos solo podemos tener lecturas, por otro lado en un cluster, cada instancia es de lectura y escritura a través de los `replica sets`.

# Diferencias

¿Qué diferencia el almacenamiento de galera con otros cluster?

UN ejemplo, es que en galera, cada rack, tiene sus propios datos, mientras que clusters como oracle rac cada proceso ataca a un nodo con datos. Las instancias de datos de galera son replicas entre multiples nodos. 

# Funcionamiento

La funcionalidad de Galera viene en forma de una librería compartida (WSREP) que se vincula al motor de base de datos. 

Consiste de lo siguientes componentes:
- WSREP API: interfaz y funciones de acceso a los servidores
- WSREP HOOKS: integración de WSREP con el motor de base de datos
- GALERA PROVIDER: implementa la API wsrep para Galera
- CERTIFICATION: Controla los write sets y realiza la certificación
	- Write set: es el conjunto de datos que se están manejando.
- REPLICATION: gestión de replicación
- GCS FRAMEWORK: arquitectura para comunicación de grupo.

![[Pasted image 20231016213209.png]]

El proceso de replicación en base de certificación se describe en el siguiente diagrama de funcionamiento.

![[Pasted image 20231016213540.png]]

El conjunto de datos modificados es el write set, a este conjunto se comprobaran que no hayan colisiones entre multiples servidores, si el proceso de certificación funciona, e dan los commits, luego los write sets se van a cada servidor y esto realiza un cambio.

Galera trabaja con los `global id`, una vez llegado a un punto de commit, se genera un vector que se comprueba que los cambios sean validos, si 2 transacciones hacen un cambio en la misma fila, gana el que haya entrado primero en el map. Galera funciona de esta manera, porque es rara la vez que suceda una colisión, pero hay que tener en cuenta que sí pueden suceder las colisiones. 

# Requisitos

Los requisitos para usar galera son mínimos.

- Servidor: como mínimo los siguientes requisitos
	- 1 GHz single core CPU
	- 512 MB RAM
	- 100 Mbps network connectivity
- OS con alguna versión de Linux
- SWAP en el servidor (o más RAM)
- Desactivar SELinux para MySQL
- Permitir el acceso a los puertos 3306, 4567, 4568 y 4444 (son los default)
- Por lo menos 3 máquinas (pueden ser 3 VM) o 3 computadoras físicas

# Información

Algunas páginas en las que podemos encontrar información sobre galera son las siguientes.

- [Galera Cluster](https://galeracluster.com/)
- [Maria DB Galera Cluster](https://mariadb.com/kb/en/galera-cluster/)

# Configuración

Usaremos galera para MariaDB, con MariaDB 11.01 o superior, así que iremos a la página de MariaDB con galera con SELinux. 

1. Saber si tenemos o no configurado el entorno de Linux con el comando `getenforce`
	1. `setenforce 0` desactivaría SELinux en la sesión actual, si queremos que se desactive de forma global deberíamos hacer lo siguiente: (ver la documentación del sistema operativo que estemos utilizando, el siguiente ejemplo es para Cent OS 7)
		1. `cd /etc/`
		2. `ls sel*`
		3. `cd selinx/`
		4. `nano config`
			1. Configurar `SELINUX=permissive | targeted | disabled`
			2. Si fuera MySQL, se hace con `semanage permissive -a mysqld_t`
			3. 